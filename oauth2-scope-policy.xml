<?xml version="1.0" encoding="UTF-8"?>
<Policy xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17"
        PolicyId="urn:pingidentity:policy:OAuth2ScopePolicy"
        Version="1"
        RuleCombiningAlgId="urn:oasis:names:tc:xacml:1.0:rule-combining-algorithm:deny-overrides">
  <Description>
    Determines whether an application making an OAuth2 authorization request
    should be granted a requested scope.  If any rule results in 'Deny', the
    policy will Deny.
  </Description>

  <!-- Policy Target: all OAuth requests -->
  <Target/>

  <Rule RuleId="urn:pingidentity:rule:ResourceScopeRule" Effect="Deny">
    <Description>
      Deny Resource scopes unless either the grant type is client-credentials or
      the authenticated user has a privileged entitlement.
    </Description>
    <!-- Target: scopes of type 'resource' -->
    <Target>
      <AnyOf>
        <AllOf>
          <Match MatchId="urn:oasis:names:tc:xacml:3.0:function:string-equal">
            <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">
              resource
            </AttributeValue>
            <AttributeSelector
                Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource"
                Path="type"
                DataType="http://www.w3.org/2001/XMLSchema#string"
                MustBePresent="true"/>
          </Match>
        </AllOf>
      </AnyOf>
    </Target>
    <!-- Condition: Deny unless either grant type is client-credentials or user
          has a privileged entitlement or user has an entitlement that matches
          the tags of the scope -->
    <Condition>
      <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:not">
        <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:or">
          <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-is-in">
            <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-one-and-only">
              <AttributeDesignator
                  Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action"
                  AttributeId="urn:pingidentity:names:2.0:grant-type"
                  DataType="http://www.w3.org/2001/XMLSchema#string"
                  MustBePresent="true" />
            </Apply>
            <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-bag">
              <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">
                client-credentials
              </AttributeValue>
            </Apply>
          </Apply>
          <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-at-least-one-member-of">
            <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-bag">
              <!--
                modify this list to customize the entitlement(s) that define
                eligibility for a Resource scope
              -->
              <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">
                admin
              </AttributeValue>
            </Apply>
            <AttributeSelector
                Category="urn:pingidentity:names:2.0:attribute-category:session"
                Path="subResource.entitlements.value"
                DataType="http://www.w3.org/2001/XMLSchema#string"
                MustBePresent="false"/>
          </Apply>
          <!-- allow if user has an entitlement that matches the tags of the scope -->
          <Apply FunctionId="urn:oasis:names:tc:xacml:1.0:function:string-at-least-one-member-of">
            <AttributeSelector
                Category="urn:pingidentity:names:2.0:attribute-category:session"
                Path="subResource.entitlements.value"
                DataType="http://www.w3.org/2001/XMLSchema#string"
                MustBePresent="false"/>
            <AttributeSelector
                Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource"
                Path="tags"
                DataType="http://www.w3.org/2001/XMLSchema#string"
                MustBePresent="false"/>
          </Apply>
        </Apply>
      </Apply>
    </Condition>
    <AdviceExpressions>
      <AdviceExpression AdviceId="request-denied-reason" AppliesTo="Deny">
        <AttributeAssignmentExpression AttributeId="error">
          <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">
            access_denied
          </AttributeValue>
        </AttributeAssignmentExpression>
        <AttributeAssignmentExpression AttributeId="error-description">
          <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">
            Request not authorized for scope of type Resource.
          </AttributeValue>
        </AttributeAssignmentExpression>
      </AdviceExpression>
    </AdviceExpressions>
  </Rule>

  <Rule RuleId="permit_if_no_deny" Effect="Permit">
    <Description>If there are no denials and no errors, always permit.</Description>
    <Condition>
      <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#boolean">true</AttributeValue>
    </Condition>
  </Rule>

</Policy>